CREATE DATABASE QuanLyGiaoVu
USE QuanLyGiaoVu
GO
--DROP DATABASE QuanLyGiaoVu
CREATE TABLE SINHVIEN(
	MSSV CHAR(8) PRIMARY KEY,
	HOTEN VARCHAR(40),
	NGSINH SMALLDATETIME,
	GIOITINH VARCHAR(3),
	NOISINH VARCHAR(40),
	MAKHOA VARCHAR(7)
)

CREATE TABLE KHOA(
	MAKHOA VARCHAR(7) PRIMARY KEY,
	TENKHOA VARCHAR(40),
	NGTLAP SMALLDATETIME,
	TRGKHOA CHAR(4)
)

CREATE TABLE MONHOC(
	MAMH VARCHAR(10) PRIMARY KEY,
	TENMH VARCHAR(40),
	TCLT TINYINT,
	TCTH TINYINT,
	MAKHOA VARCHAR(7)
)

CREATE TABLE GIAOVIEN(
	MAGV CHAR(4) PRIMARY KEY,
	HOTEN VARCHAR(40),
	HOCVI VARCHAR(10),
	HOCHAM VARCHAR(10),
	GIOITINH VARCHAR(3),
	NGSINH SMALLDATETIME,
	NGVL SMALLDATETIME,
	HESO NUMERIC(4,2),
	MUCLUONG MONEY,
	MAKHOA VARCHAR(7)
)

CREATE TABLE LOP(
	MALOP VARCHAR(30) PRIMARY KEY,
	SISO TINYINT,
	MAMH VARCHAR(10)
)

CREATE TABLE GIANGDAY(
	MALOP VARCHAR(30),
	MAGV CHAR(4),
	HOCKY TINYINT,
	NAM SMALLINT,
	TUNGAY SMALLDATETIME,
	DENNGAY SMALLDATETIME,
	PRIMARY KEY(MALOP, MAGV)
)

CREATE TABLE KETQUATHI(
	MSSV CHAR(8),
	MAMH VARCHAR(10),
	LANTHI TINYINT,
	NGTHI SMALLDATETIME,
	DIEM NUMERIC(4,2),
	KQUA VARCHAR(10),
	PRIMARY KEY(MSSV, MAMH, LANTHI)
)

CREATE TABLE HOC(
	MSSV CHAR(8),
	MALOP VARCHAR(30),
	PRIMARY KEY(MSSV, MALOP)
)

CREATE TABLE DIEUKIEN(
	MAMH VARCHAR(10),
	MAMH_TRUOC VARCHAR(10),
	PRIMARY KEY (MAMH, MAMH_TRUOC)
)

ALTER TABLE SINHVIEN 
ADD CONSTRAINT FK_SINHVIEN_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE KHOA 
ADD CONSTRAINT FK_KHOA_GIAOVIEN FOREIGN KEY (TRGKHOA) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE MONHOC
ADD CONSTRAINT FK_MONHOC_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE GIAOVIEN
ADD CONSTRAINT FK_GIAOVIEN_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE LOP
ADD CONSTRAINT FK_LOP_MONHOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE GIANGDAY 
ADD CONSTRAINT FK_GIANGDAY_GIAOVIEN FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE GIANGDAY 
ADD CONSTRAINT FK_GIANGDAY_LOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)

ALTER TABLE KETQUATHI
ADD CONSTRAINT FK_KETQUATHI_SINHVIEN FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE KETQUATHI
ADD CONSTRAINT FK_KETQUATHI_MONHOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE HOC
ADD CONSTRAINT FK_HOC_SINHVIEN FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE HOC
ADD CONSTRAINT FK_HOC_LOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)

ALTER TABLE DIEUKIEN
ADD CONSTRAINT FK_DIEUKIEN_MONHOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE DIEUKIEN
ADD CONSTRAINT FK_DIEUKIEN_MONHOCTRUOC FOREIGN KEY (MAMH_TRUOC) REFERENCES MONHOC(MAMH)

SET DATEFORMAT DMY
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('KHMT', 'Khoa hoc may tinh', '7/6/2005')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('HTTT', 'He thong thong tin', '7/6/2005')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('CNPM', 'Cong nghe phan mem', '7/6/2005')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('MMT&TT', 'Mang may tinh va truyen thong', '7/6/2005')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('KTMT', 'Ky thuat may tinh', '7/6/2005')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('KH&KTTT', 'Khoa hoc va Ky thuat thong tin', '9/11/2018')


INSERT INTO GIAOVIEN VALUES ('GV01', 'Ho Thanh Son', 'ThS', Null, 'Nam', '2/5/1989', '1/11/2017', 3.50, 2025000, 'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV02', 'Tran Tam Thanh', 'ThS', Null, 'Nam', '17/12/1990', '20/4/2018', 3.50, 2250000, 'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV03', 'Do Nghiem Phung', 'ThS', Null, 'Nu', '1/8/1992', '23/9/2020', 3.00, 2200000, 'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV04', 'Tran Nam Son', 'TS', Null, 'Nam', '22/2/1989', '12/1/2017', 2.50, 2025000, 'KTMT')
INSERT INTO GIAOVIEN VALUES ('GV05', 'Mai Thanh Danh', 'TS', 'GS', 'Nam', '12/3/1960', '12/1/2005', 4.00, 2150000, 'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV06', 'Tran Doan Hung', 'TS', 'GS', 'Nam', '11/3/1953', '12/1/2005', 4.50, 2350000, 'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV07', 'Phan Thanh Son', 'ThS', Null, 'Nam', '1/3/1994', '23/6/2020', 2.50, 1350000, 'KH&KTTT')
INSERT INTO GIAOVIEN VALUES ('GV08', 'Le Thi Tran', 'KS', Null, 'Nu', '26/3/1996', '1/3/2020', 1.86, 860500, 'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV09', 'Le Ha Thanh', 'ThS', Null, 'Nam', '4/5/1992', '15/5/2019', 2.50, 1350000, 'KH&KTTT')
INSERT INTO GIAOVIEN VALUES ('GV10', 'Ho Thanh Tung', 'ThS', Null, 'Nam', '12/1/1987', '15/5/2010', 2.67, 1201500, 'MMT&TT')


INSERT INTO MONHOC VALUES ('IT001', 'Nhap mon lap trinh', 3, 1, 'KHMT')
INSERT INTO MONHOC VALUES ('IT004', 'Co so du lieu', 3, 1, 'HTTT')
INSERT INTO MONHOC VALUES ('IT003', 'Cau truc du lieu va giai thuat', 3, 1, 'KHMT')
INSERT INTO MONHOC VALUES ('IE108', 'Phan tich thiet ke phan mem', 3, 1, 'KH&KTTT')
INSERT INTO MONHOC VALUES ('IT002', 'Lap trinh huong doi tuong', 3, 1, 'CNPM')
INSERT INTO MONHOC VALUES ('IT005', 'Nhap mon mang may tinh', 3, 1, 'MMT&TT')
INSERT INTO MONHOC VALUES ('IE103', 'Quan ly thong tin', 3, 1, 'KH&KTTT')
INSERT INTO MONHOC VALUES ('IT007', 'He dieu hanh', 3, 1, 'KTMT')


INSERT INTO LOP VALUES ('IT003.N21', 38, 'IT003')
INSERT INTO LOP VALUES ('IT003.N22', 42, 'IT003')
INSERT INTO LOP VALUES ('IT001.N21', 42, 'IT001')
INSERT INTO LOP VALUES ('IT001.N22', 42, 'IT001')
INSERT INTO LOP VALUES ('IT004.N21', 42, 'IT004')
INSERT INTO LOP VALUES ('IE108.N21', 36, 'IE108')
INSERT INTO LOP VALUES ('IT002.N21', 42, 'IT002')
INSERT INTO LOP VALUES ('IT005.N21', 42, 'IT005')
INSERT INTO LOP VALUES ('IE103.N21', 42, 'IE103')
INSERT INTO LOP VALUES ('IE103.N22', 42, 'IE103')
INSERT INTO LOP VALUES ('IT007.N21', 30, 'IT007')
INSERT INTO LOP VALUES ('IT007.N22', 32, 'IT007')

SET DATEFORMAT DMY

INSERT INTO SINHVIEN VALUES ('21520001', 'Nguyen Thanh An', '27/1/2003', 'Nam','TpHCM', 'KHMT')
INSERT INTO SINHVIEN VALUES ('21520002', 'Tran Ngoc Han', '14/3/2003', 'Nu','Kien Giang', 'CNPM')
INSERT INTO SINHVIEN VALUES ('21520003', 'Ha Duy Lap', '18/4/2002', 'Nam','Nghe An', 'KH&KTTT')
INSERT INTO SINHVIEN VALUES ('21520004', 'Tran Ngoc Linh', '30/3/2003', 'Nu','Tay Ninh', 'KH&KTTT')
INSERT INTO SINHVIEN VALUES ('21520005', 'Tran Minh Long', '27/2/2003', 'Nam','TpHCM', 'KHMT')
INSERT INTO SINHVIEN VALUES ('21520006', 'Le Nhat Minh', '24/1/2003', 'Nam','TpHCM', 'HTTT')
INSERT INTO SINHVIEN VALUES ('21520007', 'Nguyen Nhu Nhut', '27/1/2001', 'Nam','Ha Noi', 'CNPM')
INSERT INTO SINHVIEN VALUES ('21520008', 'Nguyen Manh Tam', '27/2/2003', 'Nam','Kien Giang', 'MMT&TT')
INSERT INTO SINHVIEN VALUES ('21520009', 'Phan Thi Thanh Tam', '27/1/2003', 'Nu','Vinh Long', 'KHMT')
INSERT INTO SINHVIEN VALUES ('21520010', 'Le Hoai Thuong', '5/2/2003', 'Nu','Can Tho', 'CNPM')
INSERT INTO SINHVIEN VALUES ('21520011', 'Le Ha Vinh', '25/12/2003', 'Nam','Vinh Long', 'HTTT')
INSERT INTO SINHVIEN VALUES ('21520012', 'Nguyen Van B', '11/2/2003', 'Nam','TpHCM', 'CNPM')
INSERT INTO SINHVIEN VALUES ('21520013', 'Nguyen Thi Kim Duyen', '18/11/2003', 'Nu','TpHCM', 'KHMT')
INSERT INTO SINHVIEN VALUES ('21520014', 'Tran Thi Kim Duyen', '17/9/2002', 'Nu','TpHCM', 'KHMT')
INSERT INTO SINHVIEN VALUES ('21520015', 'Truong My Hanh', '19/5/2003', 'Nu','Dong Nai', 'KH&KTTT')
INSERT INTO SINHVIEN VALUES ('21520016', 'Nguyen Thanh Nam', '17/4/2003', 'Nam','TpHCM', 'CNPM')
INSERT INTO SINHVIEN VALUES ('21520017', 'Nguyen Thi Truc Thanh', '4/3/2003', 'Nu','Kien Giang', 'KTMT')
INSERT INTO SINHVIEN VALUES ('21520018', 'Tran Thi Bich Thuy', '8/2/2003', 'Nu','Nghe An', 'MMT&TT')
INSERT INTO SINHVIEN VALUES ('21520019', 'Huynh Thi Kim Trieu', '8/4/2003', 'Nu','Tay Ninh', 'KTMT')
INSERT INTO SINHVIEN VALUES ('21520020', 'Pham Thanh Trieu', '23/2/2003', 'Nam','TpHCM', 'KH&KTTT')


INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('IT002', 'IT001')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('IT003', 'IT001')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('IT007', 'IT001')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('IE103', 'IT004')


SET DATEFORMAT DMY

INSERT INTO KETQUATHI VALUES ('21520001', 'IT001', 1, '28/12/2021', 9.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520001', 'IT003', 1, '19/7/2022', 9.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520001', 'IT002', 1, '20/7/2022', 9.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520001', 'IT004', 1, '27/12/2022', 10.00, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520002', 'IT001', 1, '28/12/2021', 7.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520002', 'IT007', 1, '24/12/2022', 4.25, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('21520002', 'IT004', 1, '27/12/2022', 7.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520002', 'IE103', 1, '14/6/2023', 7.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520003', 'IT001', 1, '28/12/2021', 8.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520003', 'IT002', 1, '20/7/2022', 7.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520003', 'IT004', 1, '27/12/2022', 10.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520003', 'IE108', 1, '8/12/2022', 6.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520003', 'IE103', 1, '15/6/2023', 8.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520004', 'IT001', 1, '28/12/2021', 6.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520004', 'IT002', 1, '20/7/2022', 6.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520004', 'IT007', 1, '23/7/2022', 5.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520005', 'IT001', 1, '28/12/2021', 7.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520005', 'IT003', 1, '19/7/2022', 7.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520005', 'IT007', 1, '23/7/2022', 8.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520006', 'IT001', 1, '28/12/2021', 8.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520006', 'IT002', 1, '20/7/2022', 8.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520006', 'IT003', 1, '21/12/2022', 7.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520006', 'IT007', 1, '24/12/2022', 8.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520007', 'IT001', 1, '28/12/2021', 6.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520007', 'IT002', 1, '20/7/2022', 5.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520007', 'IT007', 1, '24/12/2022', 4.00, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('21520007', 'IT004', 1, '27/12/2022', 4.50, 'Khong Dat')

INSERT INTO KETQUATHI VALUES ('21520008', 'IT001', 1, '28/12/2021', 7.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520008', 'IT003', 1, '19/7/2022', 7.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520008', 'IT002', 1, '20/7/2022', 8.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520008', 'IT004', 1, '27/12/2022', 7.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520008', 'IE103', 1, '14/6/2023', 8.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520009', 'IT001', 1, '28/12/2021', 9.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520009', 'IT007', 1, '23/7/2022', 9.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520009', 'IT005', 1, '24/7/2021', 9.00, 'Dat')


INSERT INTO KETQUATHI VALUES ('21520010', 'IT001', 1, '28/12/2021', 7.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520010', 'IT007', 1, '23/7/2022', 4.50, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('21520010', 'IT005', 1, '24/7/2022', 3.00, 'Khong Dat')



INSERT INTO KETQUATHI VALUES ('21520011', 'IT001', 1, '28/12/2021', 8.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520011', 'IT003', 1, '19/7/2022', 6.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520011', 'IT004', 1, '27/12/2022', 7.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520012', 'IT001', 1, '28/12/2021', 7.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520012', 'IT005', 1, '24/7/2022', 6.00, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520013', 'IT001', 1, '28/12/2021', 6.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520013', 'IT002', 1, '20/7/2022', 7.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520013', 'IT004', 1, '27/12/2022', 8.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520013', 'IE103', 1, '15/6/2023', 9.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520014', 'IT001', 1, '28/12/2021', 5.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520014', 'IT002', 1, '20/7/2022', 4.50, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('21520014', 'IT005', 1, '24/7/2022', 4.0, 'Khong Dat')

INSERT INTO KETQUATHI VALUES ('21520015', 'IT001', 1, '28/12/2021', 9.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520015', 'IT003', 1, '19/7/2022', 9.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520015', 'IT007', 1, '23/7/2022', 8.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520015', 'IE108', 1, '8/12/2022', 9.00, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520016', 'IT001', 1, '28/12/2021', 6.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520016', 'IT003', 1, '21/12/2022', 5.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520016', 'IT007', 1, '24/12/2022', 6.00, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520017', 'IT001', 1, '28/12/2021', 7.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520017', 'IT002', 1, '20/7/2022', 7.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520017', 'IT007', 1, '24/12/2022', 3.00, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('21520017', 'IT004', 1, '27/12/2022', 3.50, 'Khong Dat')

INSERT INTO KETQUATHI VALUES ('21520018', 'IT001', 1, '28/12/2021', 8.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520018', 'IT004', 1, '27/12/2022', 9.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520018', 'IE103', 1, '14/6/2023', 8.50, 'Dat')

INSERT INTO KETQUATHI VALUES ('21520019', 'IT001', 1, '28/12/2021', 9.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520019', 'IT007', 1, '23/7/2022', 9.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520019', 'IT005', 1, '24/7/2021', 9.00, 'Dat')


INSERT INTO KETQUATHI VALUES ('21520020', 'IT001', 1, '28/12/2021', 9.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520020', 'IT003', 1, '19/7/2022', 10.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520020', 'IT002', 1, '20/7/2022', 9.00, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520020', 'IT005', 1, '24/7/2021', 8.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520020', 'IT004', 1, '27/12/2022', 9.50, 'Dat')
INSERT INTO KETQUATHI VALUES ('21520020', 'IE108', 1, '8/12/2022', 8.50, 'Dat')


SET DATEFORMAT DMY

INSERT INTO GIANGDAY VALUES ('IT003.N21', 'GV01', 2, 2021, '12/2/2022', '28/6/2022')
INSERT INTO GIANGDAY VALUES ('IT003.N22', 'GV08', 1, 2022, '8/9/2022', '7/12/2022')
INSERT INTO GIANGDAY VALUES ('IT001.N21', 'GV01', 1, 2021, '3/9/2021', '9/12/2021')
INSERT INTO GIANGDAY VALUES ('IT001.N22', 'GV08', 1, 2022, '3/9/2021', '9/12/2021')
INSERT INTO GIANGDAY VALUES ('IT004.N21', 'GV02', 1, 2022, '8/9/2022', '7/12/2022')
INSERT INTO GIANGDAY VALUES ('IE108.N21', 'GV09', 1, 2022, '8/9/2022', '21/11/2022')
INSERT INTO GIANGDAY VALUES ('IT002.N21', 'GV03', 2, 2021, '12/2/2022', '28/6/2022')
INSERT INTO GIANGDAY VALUES ('IT005.N21', 'GV10', 2, 2021, '12/2/2022', '28/6/2022')
INSERT INTO GIANGDAY VALUES ('IE103.N21', 'GV07', 2, 2022, '27/2/2023', '20/5/2023') --- '14/6/2023'
INSERT INTO GIANGDAY VALUES ('IE103.N22', 'GV09', 2, 2022, '27/2/2023', '20/5/2023') --- '15/6/2023'
INSERT INTO GIANGDAY VALUES ('IT007.N21', 'GV04', 2, 2021, '12/2/2022', '28/6/2022')
INSERT INTO GIANGDAY VALUES ('IT007.N22', 'GV04', 1, 2022, '8/9/2022', '7/12/2022')

-- Hoc

INSERT INTO HOC VALUES ('21520001', 'IT001.N21')
INSERT INTO HOC VALUES ('21520001', 'IT003.N21')
INSERT INTO HOC VALUES ('21520001', 'IT002.N21')
INSERT INTO HOC VALUES ('21520001', 'IT004.N21')

INSERT INTO HOC VALUES ('21520002', 'IT001.N21')
INSERT INTO HOC VALUES ('21520002', 'IT007.N22')
INSERT INTO HOC VALUES ('21520002', 'IT004.N21')
INSERT INTO HOC VALUES ('21520002', 'IE103.N21')

INSERT INTO HOC VALUES ('21520003', 'IT001.N22')
INSERT INTO HOC VALUES ('21520003', 'IT002.N21')
INSERT INTO HOC VALUES ('21520003', 'IT004.N21')
INSERT INTO HOC VALUES ('21520003', 'IE108.N21')
INSERT INTO HOC VALUES ('21520003', 'IE103.N22')

INSERT INTO HOC VALUES ('21520004', 'IT001.N22')
INSERT INTO HOC VALUES ('21520004', 'IT002.N21')
INSERT INTO HOC VALUES ('21520004', 'IT007.N21')

INSERT INTO HOC VALUES ('21520005', 'IT001.N21')
INSERT INTO HOC VALUES ('21520005', 'IT003.N21')
INSERT INTO HOC VALUES ('21520005', 'IT007.N21')

INSERT INTO HOC VALUES ('21520006', 'IT001.N22')
INSERT INTO HOC VALUES ('21520006', 'IT002.N21')
INSERT INTO HOC VALUES ('21520006', 'IT003.N22')
INSERT INTO HOC VALUES ('21520006', 'IT007.N22')

INSERT INTO HOC VALUES ('21520007', 'IT001.N21')
INSERT INTO HOC VALUES ('21520007', 'IT002.N21')
INSERT INTO HOC VALUES ('21520007', 'IT007.N22')
INSERT INTO HOC VALUES ('21520007', 'IT004.N21')

INSERT INTO HOC VALUES ('21520008', 'IT001.N21')
INSERT INTO HOC VALUES ('21520008', 'IT003.N21')
INSERT INTO HOC VALUES ('21520008', 'IT002.N21')
INSERT INTO HOC VALUES ('21520008', 'IT004.N21')
INSERT INTO HOC VALUES ('21520008', 'IE103.N21')

INSERT INTO HOC VALUES ('21520009', 'IT001.N22')
INSERT INTO HOC VALUES ('21520009', 'IT007.N21')
INSERT INTO HOC VALUES ('21520009', 'IT005.N21')


INSERT INTO HOC VALUES ('21520010', 'IT001.N21')
INSERT INTO HOC VALUES ('21520010', 'IT007.N21')
INSERT INTO HOC VALUES ('21520010', 'IT005.N21')



INSERT INTO HOC VALUES ('21520011', 'IT001.N22')
INSERT INTO HOC VALUES ('21520011', 'IT003.N21')
INSERT INTO HOC VALUES ('21520011', 'IT004.N21')

INSERT INTO HOC VALUES ('21520012', 'IT001.N21')
INSERT INTO HOC VALUES ('21520012', 'IT005.N21')

INSERT INTO HOC VALUES ('21520013', 'IT001.N22')
INSERT INTO HOC VALUES ('21520013', 'IT002.N21')
INSERT INTO HOC VALUES ('21520013', 'IT004.N21')
INSERT INTO HOC VALUES ('21520013', 'IE103.N22')

INSERT INTO HOC VALUES ('21520014', 'IT001.N21')
INSERT INTO HOC VALUES ('21520014', 'IT002.N21')
INSERT INTO HOC VALUES ('21520014', 'IT005.N21')

INSERT INTO HOC VALUES ('21520015', 'IT001.N22')
INSERT INTO HOC VALUES ('21520015', 'IT003.N21')
INSERT INTO HOC VALUES ('21520015', 'IT007.N21')
INSERT INTO HOC VALUES ('21520015', 'IE108.N21')

INSERT INTO HOC VALUES ('21520016', 'IT001.N21')
INSERT INTO HOC VALUES ('21520016', 'IT003.N22')
INSERT INTO HOC VALUES ('21520016', 'IT007.N22')

INSERT INTO HOC VALUES ('21520017', 'IT001.N22')
INSERT INTO HOC VALUES ('21520017', 'IT002.N21')
INSERT INTO HOC VALUES ('21520017', 'IT007.N22')
INSERT INTO HOC VALUES ('21520017', 'IT004.N21')

INSERT INTO HOC VALUES ('21520018', 'IT001.N22')
INSERT INTO HOC VALUES ('21520018', 'IT004.N21')
INSERT INTO HOC VALUES ('21520018', 'IE103.N21')

INSERT INTO HOC VALUES ('21520019', 'IT001.N21')
INSERT INTO HOC VALUES ('21520019', 'IT007.N21')
INSERT INTO HOC VALUES ('21520019', 'IT005.N21')


INSERT INTO HOC VALUES ('21520020', 'IT001.N21')
INSERT INTO HOC VALUES ('21520020', 'IT003.N21')
INSERT INTO HOC VALUES ('21520020', 'IT002.N21')
INSERT INTO HOC VALUES ('21520020', 'IT005.N21')
INSERT INTO HOC VALUES ('21520020', 'IT004.N21')
INSERT INTO HOC VALUES ('21520020', 'IE108.N21')

-- STORED PROCEDURE
-- 1. Đưa vào MSSV và xuất ra điểm thi từng môn của sinh viên đó để CVHT đánh giá và dặn dò
CREATE PROCEDURE PROC_SV_DIEM
	@MSSV CHAR(8)
AS
BEGIN
	DECLARE @SV_DIEM TABLE (MSSV CHAR(8), HOTEN VARCHAR(40), MAMH VARCHAR(10), TENMH VARCHAR(40), DIEM NUMERIC(4,2), KQUA VARCHAR(10))
	IF EXISTS (SELECT * FROM KETQUATHI WHERE MSSV = @MSSV)
		BEGIN
			INSERT INTO @SV_DIEM
			SELECT KQT.MSSV, HOTEN, KQT.MAMH, TENMH, DIEM, KQUA
			FROM SINHVIEN SV JOIN KETQUATHI KQT ON SV.MSSV = KQT.MSSV JOIN MONHOC MH ON KQT.MAMH = MH.MAMH
			WHERE KQT.MSSV = @MSSV
			SELECT * 
			FROM @SV_DIEM
		END
	ELSE
		BEGIN
			PRINT N'MSSV không tồn tại'
			RETURN 0
		END
END
GO

-- 1.1 THỰC THI VÀ KIỂM TRA
DECLARE @SV_DIEM TABLE (MSSV CHAR(8), HOTEN VARCHAR(40), MAMH VARCHAR(10), TENMH VARCHAR(40), DIEM NUMERIC(4,2), KQUA VARCHAR(10)) 
EXEC PROC_SV_DIEM 21521000 -- THẤT BẠI
DECLARE @SV_DIEM TABLE (MSSV CHAR(8), HOTEN VARCHAR(40), MAMH VARCHAR(10), TENMH VARCHAR(40), DIEM NUMERIC(4,2), KQUA VARCHAR(10)) 
EXEC PROC_SV_DIEM 21520003 -- THÀNH CÔNG
-- 1.2 XÓA
DROP PROC PROC_SV_DIEM
GO

-- 2. Đưa vào HOCVI hoặc HOCHAM trả ra: Số GV thỏa học vị/ học hàm và danh sách các giảng viên thỏa điều kiện, nếu không tìm thấy trả về 0.
CREATE PROCEDURE PROC_SOGV_BY_HVI
	@HOCVI VARCHAR(10), @SLGV INT OUTPUT
AS
BEGIN
	IF EXISTS (SELECT * FROM GIAOVIEN WHERE HOCVI = @HOCVI)
		BEGIN
			SELECT @SLGV = COUNT(*)
			FROM GIAOVIEN
			WHERE HOCVI = @HOCVI
			SELECT * FROM GIAOVIEN WHERE HOCVI = @HOCVI
		END
	ELSE
		SET @SLGV = 0
END
GO

CREATE PROCEDURE PROC_SOGV_BY_HHAM
	@HOCHAM VARCHAR(10), @SLGV INT OUTPUT
AS
BEGIN
	IF EXISTS (SELECT * FROM GIAOVIEN WHERE HOCHAM = @HOCHAM)
		BEGIN
			SELECT @SLGV = COUNT(*)
			FROM GIAOVIEN
			WHERE HOCHAM = @HOCHAM
			SELECT * FROM GIAOVIEN WHERE HOCHAM = @HOCHAM
		END
	ELSE
		SET @SLGV = 0
END
GO

-- 2.1 THỰC THI VÀ KIỂM TRA
-- Đếm SL bằng HOCVI
DECLARE @HOCVI VARCHAR(10), @SLGV INT
SET @HOCVI = 'ThS'
EXEC PROC_SOGV_BY_HVI @HOCVI, @SLGV OUTPUT
PRINT N'Số giảng viên có học vị ' + @HOCVI + N' là: ' + CAST(@SLGV AS VARCHAR)
-- Đếm SL bằng HOCHAM
DECLARE @HOCHAM VARCHAR(10), @SLGV INT
SET @HOCHAM = 'GS'
EXEC PROC_SOGV_BY_HHAM @HOCHAM, @SLGV OUTPUT
PRINT N'Số giảng viên có học hàm ' + @HOCHAM + N' là: ' + CAST(@SLGV AS VARCHAR)
-- 2.2 XÓA
DROP PROC PROC_SOGV_BY_HVI
DROP PROC PROC_SOGV_BY_HHAM
GO

-- TRIGGER
-- 1. Khi xóa 1 sinh viên thôi học sẽ xóa tất cả các thông tin liên quan
CREATE TRIGGER TRIG_DELETE_SV
ON SINHVIEN INSTEAD OF DELETE
AS
	BEGIN
		DECLARE @MSSV CHAR(8)
		DECLARE @MALOP VARCHAR(30)
		SELECT @MSSV = MSSV FROM DELETED 
		DELETE FROM HOC WHERE HOC.MSSV = @MSSV
		DELETE FROM SINHVIEN WHERE SINHVIEN.MSSV = @MSSV
		UPDATE LOP SET SISO = SISO - 1 FROM LOP JOIN deleted ON LOP.MALOP = deleted.MALOP WHERE deleted.MSSV = @MSSV
	END
GO

-- 1.1 THỰC THI VÀ KIỂM TRA
DELETE FROM SINHVIEN WHERE MSSV = '21520002'
SELECT * FROM SINHVIEN
SELECT * FROM HOC
SELECT * FROM LOP
-- 1.2 KHÔI PHỤC DỮ LIỆU
INSERT INTO SINHVIEN VALUES ('21520002', 'Tran Ngoc Han', '14/3/2003', 'Nu','Kien Giang', 'CNPM')
INSERT INTO HOC VALUES ('21520002', 'IT001.N21') -- 42
INSERT INTO HOC VALUES ('21520002', 'IT007.N22') -- 32
INSERT INTO HOC VALUES ('21520002', 'IT004.N21') -- 42
INSERT INTO HOC VALUES ('21520002', 'IE103.N21') -- 42
UPDATE LOP SET SISO = SISO + 1 FROM LOP JOIN HOC ON LOP.MALOP = HOC.MALOP WHERE HOC.MSSV = '21520002'
-- 1.3 XÓA
DROP TRIGGER TRIG_DELETE_SV
GO

-- 2. Ngày bắt đầu (TUNGAY) của 1 lớp phải nhỏ hơn ngày kết thúc (DENNGAY) của lớp đó   
CREATE TRIGGER TGBD_TGKT
ON GIANGDAY
FOR INSERT, UPDATE
AS
BEGIN
	IF ((SELECT TUNGAY FROM inserted) >= (SELECT DENNGAY FROM inserted))
		BEGIN
			RAISERROR(N'Thời gian bắt đầu phải nhỏ hơn thời gian kết thúc môn học', 16, 1)
            ROLLBACK TRANSACTION
        END
END
-- 2.1 THỰC THI VÀ KIỂM TRA
INSERT INTO GIANGDAY VALUES ('IT004.N21', 'GV05', 1, 2022, '07/12/2022', '08/09/2022') -- THẤT BẠI
INSERT INTO GIANGDAY VALUES ('IT004.N21', 'GV05', 1, 2022, '22/09/2022', '01/12/2022') -- THÀNH CÔNG
SELECT * FROM GIANGDAY
-- 2.2 KHÔI PHỤC DỮ LIỆU
DELETE FROM GIANGDAY WHERE MALOP = 'IT004.N21' AND MAGV = 'GV05'
-- 2.3 XÓA
DROP TRIGGER TGBD_TGKT
GO

-- 3. DIEM không được nhỏ hơn 0 hoặc lớn hơn 10
CREATE TRIGGER CHECK_DIEM
ON KETQUATHI
FOR INSERT, UPDATE
AS
BEGIN
	IF ((SELECT DIEM FROM inserted) < 0 OR (SELECT DIEM FROM inserted) > 10)
		BEGIN
			RAISERROR(N'Điểm môn học không được nhỏ hơn 0 hoặc lớn hơn 10', 16, 1)
            ROLLBACK TRANSACTION
        END
END

-- 3.1 THỰC THI VÀ KIỂM TRA
INSERT INTO KETQUATHI VALUES ('21520001', 'IT007', 1, '24/12/2022', 11.00, 'Dat') -- THẤT BẠI
INSERT INTO KETQUATHI VALUES ('21520001', 'IT007', 1, '24/12/2022', 7.50, 'Dat') -- THÀNH CÔNG
SELECT * FROM KETQUATHI
-- 3.2 KHÔI PHỤC DỮ LIỆU
DELETE FROM KETQUATHI WHERE MSSV = '21520001' AND MAMH = 'IT007'
-- 3.3 XÓA
DROP TRIGGER CHECK_DIEM
GO

-- CRYSTAL REPORT
-- 1. Tạo report thống kê điểm của sinh viên theo từng môn học 
CREATE VIEW THONGKE_DIEM
AS
	SELECT MH.MAMH, TENMH, SV.MSSV, HOTEN, DIEM
	FROM SINHVIEN SV JOIN KETQUATHI KQT ON SV.MSSV = KQT.MSSV JOIN MONHOC MH ON KQT.MAMH = MH.MAMH
GO

SELECT * FROM THONGKE_DIEM

DROP VIEW THONGKE_DIEM

-- 2. Tạo report thống kê điểm của các sinh viên học lớp IT007.N21
CREATE VIEW BANGDIEM_IT007_N21
AS
	SELECT SV.MSSV, HOTEN, MAKHOA, DIEM
	FROM SINHVIEN SV JOIN KETQUATHI KQT ON SV.MSSV = KQT.MSSV JOIN HOC ON KQT.MSSV = HOC.MSSV
	WHERE MALOP = 'IT007.N21' AND MAMH = 'IT007'
GO

SELECT * FROM BANGDIEM_IT007_N21

DROP VIEW BANGDIEM_IT007_N21
